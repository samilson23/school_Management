{% extends 'student_template/base_template.html' %}
{% block page_title %} UNITS {% endblock page_title %}
{% load static %}
{% block main_content %}
<section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-12">
            <!-- general form elements -->
            <div class="card">
              <div class="card-header">
                    <h3 class="card-title text-bold">Registered Units</h3>
                  <div class="card-tools">
                    <form method="get" class="form-inline">
                      <div class="input-group input-group-sm border" style="width: 150px;">
                        {{Myfilter.code}}
                        <div class="input-group-append">
                          <button class="btn" type="submit">
                            <i class="fas fa-search"></i>
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
              </div>
              <div class="card-body table-responsive p-0">
                  <table class="table table-hover text-nowrap">
                      <thead>
                        <tr class="text-bold">
                            <th>UNIT</th>
                            <th>CODE</th>
                            <th>STAGE</th>
                        </tr>
                      </thead>
                      <tbody>
                      {% for subjects in subject_data %}
                        <tr>
                            <td>{{ subjects.subject_name }}</td>
                            <td>{{ subjects.code }}</td>
                            <td>{{ subjects.stage }}</td>
                        </tr>
                      {% endfor %}
                      </tbody>
                  </table>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
           <div class="card-footer">
              <div class="row">
                  <div class="col-lg-6">
                      <div class="pagination">
                          <span class="step-links">
                              <span class="current">
                                   Page  {{ page_obj.number }}  of  {{ page_obj.paginator.num_pages }}.
                              </span>
                          </span>
                      </div>
                  </div>
                  <div class="col-lg-6">
                      {% if subject_data.has_other_pages %}
                        <ul class="pagination float-right">
                            {% if subject_data.has_previous %}
                                <li class="paginate_button page-item"><a class="page-link" href="?page={{ subject_data.previous_page_number }}" data-dt-idx="0" tabindex="0">Previous</a></li>
                            {% else %}
                                <li class="paginate_button page-item disabled"><a class="page-link" href="#" >Previous</a></li>
                            {% endif %}
                            {% for i in page_range|default_if_none:subject_data.paginator.get_elided_page_range %}
                                {% if page_obj.number == i %}
                                    <li class="paginate_button page-item active"><a class="page-link">{{ i }}<span class="sr-only">(current)</span></a></li>
                                {% else %}
                                    {% if i == page_obj.paginator.ELLIPSIS %}
                                        <li class="paginate_button page-item"><a class="page-link" href="#">{{ i }}</a></li>
                                    {% else %}
                                        <li class="paginate_button page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if subject_data.has_next %}
                              <li class="page-item"><a class="page-link" href="?page={{ subject_data.next_page_number }}" >Next</a></li>
                            {% else %}
                              <li class="page-item disabled"><a class="page-link" href="#" >Next</a></li>
                            {% endif %}
                        </ul>
                      {% endif %}
                  </div>
              </div>
          </div>
       </div>
      </div>
    </section>
    <!-- /.content -->
{% endblock main_content %}
{% block custom_js %}
<script>
  $(document).ready(function(){



      $("#fetch_attendance").click(function(){
             var subject=$("#subjects").val();
             var session_year=$("#session_year_id").val();

          $.ajax({
                  url:'{% url 'get_attendance_date' %}',
                  type:'POST',
                  data:{subjects:subject,session_year_id:session_year},
              })
              .done(function(response){
                  var json_data=JSON.parse(response);
                  if(json_data.length>0)
                  {
                      var html_data="";
                      for(key in json_data)
                      {
                          html_data+="<option value="+json_data[key]["id"]+">"+json_data[key]["attendance_date"]+"</option>";
                      }
                      $("#error_attendance").html("");
                      $("#error_attendance").hide();
                      $("#attendance_block").show();
                      $("#fetch_student_block").show();
                      $("#attendance_date").html(html_data);
                   }
                   else
                   {
                      $("#error_attendance").html("No Attendance Data Found");
                      $("#error_attendance").show();
                      $("#attendance_block").hide();
                      $("#fetch_student_block").hide();
                      $("#attendance_date").html("");
                   }
              })
              .fail(function(){
                  alert("Error in Fetching Units")
                  $("#error_attendance").html("");
                  $("#attendance_block").hide();
                  $("#fetch_student_block").hide();

              });


      })


      $("#fetch_student").click(function(){

          var attendance_date=$("#attendance_date").val()

          $.ajax({
              url:'{% url 'get_attendance_student' %}',
              type:'POST',
              data:{attendance_date:attendance_date},
          })
          .done(function(response){
              var json_data=JSON.parse(response);
              var div_data="<div class='form-group'><label>Student Attendance : </label></div><div class='form-group'><div class='row'>";
              for(key in json_data)
              {
                  div_data+="<div class='col-lg-3'><div class='form-check'><input type='checkbox' ";
                  if(json_data[key]['status'])
                  {
                      div_data+="checked='checked'";
                  }
                  else{
                      div_data+="";
                  }
                  div_data+="name='student_data[]' value='"+json_data[key]['id']+"'><label class='form-check-label'>"+json_data[key]['name']+"</label> ";


                   if(json_data[key]['status'])
                  {
                      div_data+="<b> [ Present ]</b>";
                  }
                  else{
                      div_data+="<b> [ Absent ]</b>";
                  }

                  div_data+="</div></div>";
              }
              div_data+="</div></div>";
              div_data+="<div class='form-group'>";
              div_data+="<button id='save_attendance' class='btn btn-success btn-block' type='button'>Save Attendance Data</button>";
              div_data+="</div>";

              $("#student_data").html(div_data);

          })
          .fail(function(){
              alert("Error in Fetching Student")
          })

       })

       $(document).on("click","#save_attendance",function(){

              $(this).attr("disabled","disabled")
              $(this).text("Saving Attendance Data...")
              var student_data=$("input[name='student_data[]']").map(function(){
                      if($(this).is(":checked")){
                          return {"id":$(this).val(),"status":1};
                      }
                      else{
                          return {"id":$(this).val(),"status":0};
                      }
               }).get()
              var attendance_date=$("#attendance_date").val();
              student_data=JSON.stringify(student_data)

              $.ajax({
                      url:'{% url 'save_updateattendance_student' %}',
                      type:'POST',
                      data:{student_ids:student_data,attendance_date:attendance_date},
                  })
                  .done(function(response){

                      if(response=="OK"){
                          alert("Attendance Save")
                      }
                      else{
                          alert("Error in Saving Data")
                      }
                      location.reload()
                  })
                  .fail(function(){
                      alert("Error in Saving Student")
                  })

      })

  })

</script>
{% endblock custom_js %}